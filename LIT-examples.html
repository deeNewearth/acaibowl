<html>

<head>
  <title>LIT Protocol Minimal JWT Example</title>
  <script onload='LitJsSdk.litJsSdkLoadedInALIT()' src="https://jscdn.litgateway.com/index.web.js"></script>
  <!--<script onload='litJsSdkLoaded()' src="https://jscdn.litgateway.com/index.web.js"></script>-->
  <script>
    // successful test - this is one of the stock tests that came with the downloaded package
    async function mintNft() {
      document.getElementById('mintingStatus').innerText = "Minting, please wait for the tx to confirm..."

      window.chain = document.getElementById('selectedChain').value
//debugger;

      const {
        txHash,
        tokenId,
        tokenAddress,
        mintingAddress,
        authSig
      } = await LitJsSdk.mintLIT({ chain: window.chain, quantity: 1 })
      window.tokenId = tokenId
      window.tokenAddress = tokenAddress
      window.authSig = authSig
      window.mintingAddress = mintingAddress
      
      document.getElementById('mintingStatus').innerText = "Minted!  Tx hash is " + txHash
      
      let detailText = "curr account: " + window.mintingAddress + "\n"
        + "  minted token addr: " + window.tokenAddress;
      document.getElementById('details').innerText = detailText;
    }

    async function litJsSdkLoaded(){
      var litNodeClient = new LitJsSdk.LitNodeClient()
      litNodeClient.connect()
      window.litNodeClient = litNodeClient
    }

    // successful test - this is one of the stock tests that came with the downloaded package    
    async function provisionAccess() {
      document.getElementById('provisioningStatus').innerText = "Provisioning, please wait..."
      window.accessControlConditions = [
        {
          contractAddress: LitJsSdk.LIT_CHAINS[window.chain].contractAddress,
          standardContractType: 'ERC1155',
          chain: window.chain,
          method: 'balanceOf',
          parameters: [
            ':userAddress',
            window.tokenId.toString()
          ],
          returnValueTest: {
            comparator: '>',
            value: '0'
          }
        }
      ]
      
      const randomUrlPath = "/" + Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      window.resourceId = {
        baseUrl: 'my-dynamic-content-server.com',
        path: randomUrlPath, // this would normally be your url path, like "/webpage.html" for example
        orgId: "",
        role: "",
        extraData: ""
      }
      await litNodeClient.saveSigningCondition({
        accessControlConditions: window.accessControlConditions,
        chain: window.chain,
        authSig: window.authSig,
        resourceId: window.resourceId
      })
      document.getElementById('provisioningStatus').innerText = "Provisioned!"
    }

    // successful test - this is one of the stock tests that came with the downloaded package    
    async function requestJwt() {
      document.getElementById('requestingStatus').innerText = "Requesting JWT, please wait..."

      window.jwt = await litNodeClient.getSignedToken({
        accessControlConditions: window.accessControlConditions,
        chain: window.chain,
        authSig: window.authSig,
        resourceId: window.resourceId
      })

      document.getElementById('requestingStatus').innerText = "JWT Obtained!  It is  " + window.jwt
    }

    // successful test - this is one of the stock tests that came with the downloaded package    
    async function verifyJwt() {
      document.getElementById('verificationStatus').innerText = "Verifying, please wait..."
      const data = await fetch('/verify?jwt=' + window.jwt).then(resp => resp.json())
      document.getElementById('verificationStatus').innerText = "Verified!  Response is \n" + JSON.stringify(data, null, 2)
      document.getElementById('verificationNote').style = 'display: block;'
    }

    // successful test: this is the syntax to make this call work
    async function sendToken() {
      let toAddr = document.getElementById('toAddress').value;
      const metaData = {
        tokenAddress: window.tokenAddress,
        tokenId: window.tokenId,
        chain: window.chain
      } 
      let success = await LitJsSdk.sendLIT({ tokenMetadata: metaData, to: toAddr });
    }

    // success, tho I haven't seen it resolve yet: still a promise, but know errors
    async function findTokensByAddr() { 
debugger;
      //const litTokens = await LitJsSdk.findLITs({ chain: window.chain, accountAddress: window.mintingAddress });
      const holderAddr = document.getElementById('holderAddress').value;
      const litTokens = await LitJsSdk.findLITs({ chain: 'mumbai', accountAddress: holderAddr });
      document.getElementById('details2').innerText = "acct: " + holderAddr + "\n  Tokens owned by acct: " + litTokens.toString();
    }

    // success: this seems to work - sent in a jpg, received an ecrypted string back
    async function encryptFileToDataURL(input) {
      let file = input.files[0]; 
      const fileURL = await LitJsSdk.fileToDataUrl(file);
      document.getElementById('details2').innerText = "file URL for input file: " + fileURL;
    }

    /* RETURN AN AUTH: user's metamask needs to be conneted, I believe (and the chain
     * which is hardcoded at the moment) */
    async function checkAndSignAuth() {
//debugger;
      const authSig = await LitJsSdk.checkAndSignAuthMessage({chain: 'mumbai'});
      localStorage.setItem('lit-authSig', authSig);
      document.getElementById('details2').innerText = "authSig: " + authSig;
    } 

    // not working yet: haven't figured this out
    async function iFrameInjection() {      
      const iFrameStuff = {
	      destinationId: 'iFrameIdea',
	      title: 'GATEDDATA',
	      fileUrl: './gatedData.html',
	      className: 'testClass'
      }
      try {
        const retVal = await LitJsSdk.injectViewerIFrame(iFrameStuff);
      } catch(e) {
        alert(e);
      }      
    }
  </script>
</head>

<body>
  <h1>
    LIT Protocol Minimal JWT Example
  </h1>

  <!-- Dee - I changed the names/values in the drop down but have only been able to mint 
    using mumbai. Not sure about the syntax should be to hook to harmony's testnet either
    + their faucet was down this evening. Couldn't get it to connect to georli to mint -
    they may not have have a contract there. Lit's examples originally pointed to mainnet, xdai, etc -->
  <h2>Step 1: Mint an NFT</h2>
  Chain to mint on:
  <select id='selectedChain'>
    <option value='mumbai'>Mumbai testnet</option>
    <option value='harmony testnet'>Harmony testnet</option>
    <option value='robsten' selected>Robsten testnet</option>
    <option value='georli'>Georli testnet</option>
    <option value='xdai'>xDai</option>
  </select>
  <br />
  <br />
  <button onclick="mintNft()">Mint NFT</button>
  <br />
  <br />
  <div id='mintingStatus'></div>

  <h2>Step 2: Provision access to a resource</h2>
  <button onclick="provisionAccess()">Provision access</button>
  <br />
  <br />
  <div id='provisioningStatus'></div>

  <h2>Step 3: Request a JWT to authenticate the user</h2>
  <button onclick="requestJwt()">Request JWT</button>
  <br />
  <br />
  <div id='requestingStatus'></div>

  <h2>Step 4: Verify the JWT on the server</h2>
  <button onclick="verifyJwt()">Verify the JWT</button>
  <br />
  <br />
  <pre id='verificationStatus'></pre>
  <br />
  <p id='verificationNote' style='display: none;'>
    The "verified" variable is a boolean that indicates whether or not the signature verified properly. Note: YOU MUST
    CHECK THE PAYLOAD AGAINST THE CONTENT YOU ARE PROTECTING. This means you need to look at "payload.baseUrl" which
    should match the hostname of the server, and you must also look at "payload.path" which should match the path being
    accessed. You should also check that payload.orgId, payload.role, and payload.extraData are empty. If these do not
    match what you're expecting, you should reject the request.
  </p>

  <div>
    <!--<button onclick="displayDetails()">Talking to LIT</button>-->
    <h3>Sample details from LIT object</h3>
    <pre id='details'>none...</pre>
    <br />
    <button onclick="findTokensByAddr()">Acct Tokens</button>
    <input type="text" id="holderAddress" />
    <br />
    <br />
    <input onchange="encryptFileToDataURL(this)" type="file" width=" 200px">
    <pre id='details2'></pre>
    <br />
    <div>
      <button onclick="sendToken()">send token to</button>
      <input type="text" id="toAddress" />
    </div>
    <div>
      <br /><br />
      <button onclick="checkAndSignAuth()">Get Auth</button>

    </div>
  </div>

</body>

</html>